<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Pro HR Monitor</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --surface-dark: #1e293b;
            --surface-light: #334155;
            --primary: #10b981; /* Green */
            --warning: #fbbf24; /* Yellow */
            --orange: #f97316;  /* Orange */
            --danger: #ef4444;  /* Red */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            background-color: var(--surface-dark);
            border-bottom: 1px solid var(--surface-light);
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        h1 { margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        .controls { display: flex; gap: 10px; }
        
        button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .btn-primary { background: var(--primary); color: #064e3b; }
        .btn-primary:hover { background: #34d399; }
        .btn-primary:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; }
        
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        .btn-outline { background: transparent; border: 1px solid var(--surface-light); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }

        /* --- Main Layout --- */
        main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Stats Bar */
        .session-stats {
            display: flex;
            gap: 2rem;
            padding: 0.75rem 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 1px solid var(--surface-light);
            align-items: center;
        }

        .stat-group { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
        .stat-val { font-size: 1.1rem; font-weight: 700; font-family: monospace; }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); /* Wider cards */
            gap: 1.5rem;
            padding-bottom: 2rem;
        }

        /* --- Player Card Design --- */
        .player-card {
            background: var(--surface-dark);
            border: 1px solid var(--surface-light);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .player-name { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        
        .connection-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--surface-light);
        }
        .connection-dot.connected { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* HR Display & Colors */
        .hr-display {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .big-hr {
            font-size: 4.5rem;
            font-weight: 800;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            transition: color 0.3s ease;
        }

        /* Dynamic HR Colors */
        .hr-color-resting { color: var(--primary); }
        .hr-color-elevated { color: var(--warning); }
        .hr-color-high { color: var(--orange); }
        .hr-color-extreme { color: var(--danger); }

        .hr-unit { font-size: 1rem; color: var(--text-muted); font-weight: 500; }
        
        .zone-badge {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* --- Chart Area --- */
        .chart-container {
            height: 120px;
            width: 100%; /* Ensure full width */
            position: relative;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.05);
        }

        svg.sparkline {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        path.line {
            fill: none;
            stroke: var(--primary);
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            vector-effect: non-scaling-stroke;
            transition: stroke 0.3s;
        }
        
        path.area {
            fill: rgba(16, 185, 129, 0.1);
            stroke: none;
            transition: fill 0.3s;
        }

        /* --- Animations --- */
        
        /* Pulse Animation for Spikes */
        @keyframes chart-flash {
            0% { stroke: var(--text-main); stroke-width: 3; filter: drop-shadow(0 0 0 transparent); }
            25% { stroke: var(--danger); stroke-width: 5; filter: drop-shadow(0 0 5px var(--danger)); }
            100% { stroke: var(--text-main); stroke-width: 3; filter: drop-shadow(0 0 0 transparent); }
        }

        .line-spike {
            animation: chart-flash 1s ease-out;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.02);
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: auto;
        }

        .stat-pill { display: flex; flex-direction: column; }
        .stat-pill label { font-size: 0.7rem; color: var(--text-muted); }
        .stat-pill span { font-size: 0.9rem; font-weight: 600; font-family: monospace; }
        .peak-val { color: var(--warning) !important; }

        /* Modals & Utils */
        .hidden { display: none !important; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--surface-dark);
            border: 1px solid var(--surface-light);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 450px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--surface-light);
            border-radius: 6px;
            color: white;
            margin: 10px 0 20px 0;
            box-sizing: border-box;
        }
        .form-input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        #empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
            border: 2px dashed var(--surface-light);
            border-radius: 16px;
        }
    </style>
</head>
<body>

    <header>
        <h1>ðŸŽ° Poker Pro HR</h1>
        <div class="controls">
            <button id="add-player-btn" class="btn-primary">+ Add Player</button>
            <button id="start-session" class="btn-primary" disabled>Start</button>
            <button id="stop-session" class="btn-danger hidden">Stop</button>
            <button id="reset-app" class="btn-outline">Reset</button>
        </div>
    </header>

    <main>
        <div class="session-stats">
            <div class="stat-group">
                <span class="stat-label">Duration</span>
                <span id="session-timer" class="stat-val">00:00:00</span>
            </div>
            <div class="stat-group">
                <span class="stat-label">Active Players</span>
                <span id="active-player-count" class="stat-val">0</span>
            </div>
        </div>

        <div id="players-container" class="players-grid">
            <div id="empty-state">
                <h3>No Players Connected</h3>
                <p>Click "Add Player" to connect a Garmin device.</p>
            </div>
        </div>
    </main>

    <div id="add-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 style="margin-top:0">Add New Player</h2>
            <div id="step-1">
                <label style="color: var(--text-muted); font-size: 0.9rem;">Player Name</label>
                <input type="text" id="player-name-input" class="form-input" placeholder="e.g. 'Zdun'" autocomplete="off">
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn-outline" onclick="app.closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="app.connectDevice()">Connect Bluetooth</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PokerHRApp {
            constructor() {
                this.players = [];
                this.isMonitoring = false;
                this.sessionStartTime = null;
                this.timerInterval = null;
                
                // Config
                this.historySize = 100; // Number of data points to keep
                
                // DOM Elements
                this.container = document.getElementById('players-container');
                this.emptyState = document.getElementById('empty-state');
                this.timerEl = document.getElementById('session-timer');
                this.modal = document.getElementById('add-modal');
                this.nameInput = document.getElementById('player-name-input');
                this.startBtn = document.getElementById('start-session');
                this.stopBtn = document.getElementById('stop-session');
                
                // Bind buttons
                document.getElementById('add-player-btn').onclick = () => this.openModal();
                this.startBtn.onclick = () => this.startSession();
                this.stopBtn.onclick = () => this.stopSession();
                document.getElementById('reset-app').onclick = () => location.reload();

                if (!navigator.bluetooth) console.warn("Bluetooth API not found - running in demo mode.");
            }

            openModal() {
                this.modal.classList.remove('hidden');
                this.nameInput.value = '';
                this.nameInput.focus();
            }

            closeModal() {
                this.modal.classList.add('hidden');
            }

            async connectDevice() {
                const name = this.nameInput.value.trim();
                if(!name) return alert("Enter a name");

                let device, characteristic;

                try {
                    if (navigator.bluetooth) {
                        device = await navigator.bluetooth.requestDevice({
                            filters: [{ services: ['heart_rate'] }]
                        });
                        const server = await device.gatt.connect();
                        const service = await server.getPrimaryService('heart_rate');
                        characteristic = await service.getCharacteristic('heart_rate_measurement');
                    }
                    
                    this.addPlayer(name, device, characteristic);
                    this.closeModal();

                } catch (error) {
                    console.error(error);
                    alert("Connection failed. Try again.");
                }
            }

            addPlayer(name, device, characteristic) {
                // Initialize history with 0s so chart fills from right
                const historyArr = new Array(this.historySize).fill(0);

                const player = {
                    id: Date.now(),
                    name: name,
                    device: device,
                    characteristic: characteristic,
                    history: historyArr,
                    currentHR: 0,
                    prevHR: 0, // For spike detection
                    maxHR: 0,
                    maxHRTime: null,
                    isMock: !device
                };

                this.players.push(player);
                this.renderPlayers();

                if (player.isMock) this.startMockData(player);
                else this.startRealData(player);
            }

            renderPlayers() {
                if (this.players.length > 0) {
                    this.emptyState.classList.add('hidden');
                    this.startBtn.disabled = false;
                    document.getElementById('active-player-count').textContent = this.players.length;
                }
                
                this.players.forEach(player => {
                    if (!document.getElementById(`player-${player.id}`)) {
                        this.createPlayerCard(player);
                    }
                });
            }

            createPlayerCard(player) {
                const card = document.createElement('div');
                card.id = `player-${player.id}`;
                card.className = 'player-card';
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="player-name">${player.name}</span>
                        <div class="connection-dot connected"></div>
                    </div>
                    
                    <div class="hr-display">
                        <span class="big-hr hr-color-resting" id="hr-val-${player.id}">--</span>
                        <span class="hr-unit">BPM</span>
                        <span class="zone-badge" id="zone-badge-${player.id}">WAITING</span>
                    </div>

                    <div class="chart-container">
                        <svg class="sparkline" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <defs>
                                <linearGradient id="grad-${player.id}" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:currentColor; stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:currentColor; stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            <path class="area" id="path-area-${player.id}" d="" />
                            <path class="line" id="path-line-${player.id}" d="" />
                        </svg>
                    </div>

                    <div class="stats-row">
                        <div class="stat-pill">
                            <label>Current</label>
                            <span id="current-stat-${player.id}">--</span>
                        </div>
                        <div class="stat-pill" style="text-align:right">
                            <label>Session Peak</label>
                            <span class="peak-val" id="peak-stat-${player.id}">--</span>
                        </div>
                        <div class="stat-pill" style="text-align:right">
                            <label>Peak Time</label>
                            <span id="peak-time-${player.id}">--:--</span>
                        </div>
                    </div>
                `;
                
                this.container.appendChild(card);
            }

            startRealData(player) {
                player.characteristic.startNotifications().then(() => {
                    player.characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        const val = e.target.value;
                        const hr = val.getUint8(1); 
                        this.updatePlayerHeartRate(player, hr);
                    });
                });
            }

            startMockData(player) {
                player.mockInterval = setInterval(() => {
                    let base = 65;
                    // Simulate randomness and spikes
                    if (Math.random() > 0.85) base += 25; 
                    if (Math.random() > 0.95) base += 45; 
                    const noise = Math.floor(Math.random() * 6) - 3;
                    let hr = base + noise;
                    if(hr < 45) hr = 45;
                    this.updatePlayerHeartRate(player, hr);
                }, 1000);
            }

            updatePlayerHeartRate(player, hr) {
                // Shift History
                player.prevHR = player.currentHR;
                player.currentHR = hr;
                player.history.push(hr);
                player.history.shift(); 

                // Track Max
                if (hr > player.maxHR && this.isMonitoring) {
                    player.maxHR = hr;
                    player.maxHRTime = new Date();
                }

                // UI Update
                requestAnimationFrame(() => this.updateCardUI(player));
            }

            updateCardUI(player) {
                const hrEl = document.getElementById(`hr-val-${player.id}`);
                const zoneBadge = document.getElementById(`zone-badge-${player.id}`);
                const linePath = document.getElementById(`path-line-${player.id}`);
                
                // 1. Text Update
                hrEl.textContent = player.currentHR;
                document.getElementById(`current-stat-${player.id}`).textContent = player.currentHR;
                
                if (player.maxHR > 0) {
                    document.getElementById(`peak-stat-${player.id}`).textContent = player.maxHR;
                    document.getElementById(`peak-time-${player.id}`).textContent = 
                        player.maxHRTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                }

                // 2. Color & Zone Logic
                hrEl.className = 'big-hr'; // reset
                let colorClass = 'hr-color-resting';
                let zoneText = "RESTING";
                let strokeColor = "var(--primary)";

                if (player.currentHR >= 120) {
                    colorClass = 'hr-color-extreme';
                    zoneText = "EXTREME";
                    strokeColor = "var(--danger)";
                } else if (player.currentHR >= 100) {
                    colorClass = 'hr-color-high';
                    zoneText = "HIGH";
                    strokeColor = "var(--orange)";
                } else if (player.currentHR >= 80) {
                    colorClass = 'hr-color-elevated';
                    zoneText = "ELEVATED";
                    strokeColor = "var(--warning)";
                }

                hrEl.classList.add(colorClass);
                zoneBadge.textContent = zoneText;
                
                // Update Line Color
                linePath.style.stroke = strokeColor;

                // 3. Spike Detection (Blink Animation)
                // If HR jumped up by 12 or more in one tick
                if (player.currentHR - player.prevHR > 12) {
                    linePath.classList.remove('line-spike'); // Reset anim
                    void linePath.offsetWidth; // Trigger reflow
                    linePath.classList.add('line-spike');
                }

                // 4. Draw Chart (Full Width Fix)
                this.drawChart(player, strokeColor);
            }

            drawChart(player, color) {
                const pathLine = document.getElementById(`path-line-${player.id}`);
                const pathArea = document.getElementById(`path-area-${player.id}`);
                
                const data = player.history;
                // SVG coordinate space is 0-100 x 0-100 due to viewBox
                const width = 100; 
                const height = 100;
                
                // Dynamic Y-axis
                // Filter out 0s for scaling calculation so empty history doesn't squash chart
                const activeData = data.filter(x => x > 0);
                const min = Math.min(...activeData) * 0.95 || 40;
                const max = Math.max(...activeData) * 1.05 || 100;
                const range = max - min;

                // Map points to 0-100 coordinates
                // We map based on INDEX relative to HISTORY SIZE to ensure full width
                let points = data.map((val, i) => {
                    if (val === 0) return null;
                    const x = (i / (this.historySize - 1)) * width;
                    const y = height - ((val - min) / range * height);
                    return `${x},${y}`;
                }).filter(p => p !== null);

                if (points.length < 2) return;

                const lineD = `M ${points.join(' L ')}`;
                
                // Create Area fill (closed shape)
                // We find first and last valid X to close the shape correctly
                const firstPoint = points[0].split(',');
                const lastPoint = points[points.length-1].split(',');
                const areaD = `${lineD} L ${lastPoint[0]},${height} L ${firstPoint[0]},${height} Z`;

                pathLine.setAttribute('d', lineD);
                pathArea.setAttribute('d', areaD);
                pathArea.style.color = color; // Uses currentColor in CSS
            }

            startSession() {
                this.isMonitoring = true;
                this.sessionStartTime = Date.now();
                this.startBtn.classList.add('hidden');
                this.stopBtn.classList.remove('hidden');
                document.getElementById('add-player-btn').disabled = true;

                // Reset peaks
                this.players.forEach(p => { p.maxHR = 0; p.maxHRTime = null; });

                this.timerInterval = setInterval(() => {
                    const diff = Date.now() - this.sessionStartTime;
                    this.timerEl.textContent = new Date(diff).toISOString().substr(11, 8);
                }, 1000);
            }

            stopSession() {
                this.isMonitoring = false;
                clearInterval(this.timerInterval);
                this.startBtn.classList.remove('hidden');
                this.stopBtn.classList.add('hidden');
                document.getElementById('add-player-btn').disabled = false;
            }
        }

        const app = new PokerHRApp();
    </script>
</body>
</html>